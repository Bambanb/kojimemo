<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¡ãƒ¢å¸³</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system;background:#f4f6f8;}
  header{background:#2d6cdf;color:#fff;padding:12px 12px 10px;position:sticky;top:0;z-index:10;}
  .toprow{display:flex;gap:8px;align-items:center;justify-content:space-between;}
  .title{font-size:18px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .crumb{font-size:12px;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:4px;}
  #app{padding:12px;}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
  input{padding:10px;border:1px solid #d9dee6;border-radius:8px;flex:1;min-width:180px;background:#fff;}
  button{padding:10px 12px;border:none;border-radius:10px;font-weight:600;}
  .primary{background:#2d6cdf;color:#fff;}
  .ghost{background:#fff;border:1px solid #d9dee6;}
  .danger{background:#ffecec;border:1px solid #ffb7b7;color:#b00020;}
  .card{background:#fff;border-radius:14px;padding:10px;border:1px solid #e6ebf2;}
  .list{display:flex;flex-direction:column;gap:8px;margin-top:10px;}
  .item{background:#fff;border:1px solid #e6ebf2;border-radius:12px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .left{display:flex;align-items:center;gap:10px;min-width:0;}
  .icon{font-size:18px;flex:0 0 auto;}
  .name{font-weight:700;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .meta{font-size:12px;opacity:.65;margin-top:2px;}
  .small{font-size:12px;opacity:.7;}
  #editorView{position:fixed;inset:0;background:#f4f6f8;display:none;flex-direction:column;}
  #editorHeader{background:#2d6cdf;color:#fff;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
  #editorHeader .hleft{display:flex;flex-direction:column;gap:2px;min-width:0;}
  #editorTitle{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  #editorCount{font-size:12px;opacity:.9;}
  #editorActions{display:flex;gap:8px;flex:0 0 auto;}
  textarea{flex:1;width:100%;border:none;outline:none;padding:12px;font-size:16px;line-height:1.7;resize:none;background:#fff;}
</style>
</head>
<body>
  <header>
  <div class="toprow">
    <div class="title">ğŸ—‚ ãƒ¡ãƒ¢å¸³</div>
    <div class="small" id="stats"></div>
  </div>
  <div class="crumb" id="breadcrumb"></div>
</header>

<div id="app">
  <div class="toolbar">
    <button class="ghost" id="backBtn" onclick="goUp()">â† ä¸Šã¸</button>
    <input id="nameInput" placeholder="ãƒ•ã‚©ãƒ«ãƒ€å / ãƒ¡ãƒ¢å">
    <button class="primary" onclick="addFolder()">ï¼‹ãƒ•ã‚©ãƒ«ãƒ€</button>
    <button class="primary" onclick="addMemo()">ï¼‹ãƒ¡ãƒ¢</button>
    <button class="danger" onclick="deleteCurrent()">ğŸ—‘ å‰Šé™¤</button>
  </div>

  <div class="card">
    <div class="small">ä»Šã„ã‚‹å ´æ‰€ã®ä¸­èº«ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã¨ãƒ¡ãƒ¢ãŒä¸€ç·’ã«ä¸¦ã¶ï¼‰</div>
    <div class="list" id="list"></div>
  </div>
</div>

<!-- Editor (å…¨ç”»é¢) -->
<div id="editorView">
  <div id="editorHeader">
    <div class="hleft">
      <div id="editorTitle">ç·¨é›†</div>
      <div id="editorCount">æ–‡å­—æ•°: 0</div>
    </div>
    <div id="editorActions">
      <button class="ghost" onclick="closeEditor()">é–‰ã˜ã‚‹</button>
      <button class="primary" onclick="saveNow()">ä¿å­˜</button>
    </div>
  </div>
  <textarea id="editor" placeholder="ã“ã“ã«æœ¬æ–‡â€¦"></textarea>
</div>

<script>
/**
 * ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆç„¡é™éšå±¤ï¼‰
 * root = { folders: {name: node}, memos: {id: {title, text, updatedAt}} }
 */
const KEY = "memoTreeV1";

function newNode(){ return { folders:{}, memos:{} }; }
let root = load() || newNode();
let path = []; // ["çš‡é¢¯","çŸ­ç·¨",...]
let selected = null; // {type:"folder", name} or {type:"memo", id}
let editingMemoId = null;
let autosaveTimer = null;

function load(){
  try { return JSON.parse(localStorage.getItem(KEY)); } catch(e){ return null; }
}
function persist(){
  localStorage.setItem(KEY, JSON.stringify(root));
}
function getNode(p = path){
  let node = root;
  for(const name of p){
    if(!node.folders[name]) node.folders[name] = newNode();
    node = node.folders[name];
  }
  return node;
}
function now(){ return Date.now(); }

function updateHeader(){
  const crumb = path.length ? "ğŸ“ / " + path.join(" / ") : "ğŸ“ /ï¼ˆãƒ«ãƒ¼ãƒˆï¼‰";
  document.getElementById("breadcrumb").textContent = crumb;
  document.getElementById("backBtn").disabled = path.length === 0;

  const node = getNode();
  const folderCount = Object.keys(node.folders).length;
  const memoCount = Object.keys(node.memos).length;
  document.getElementById("stats").textContent = `ğŸ“${folderCount} ğŸ“${memoCount}`;
}

function render(){
  selected = null;
  updateHeader();

  const node = getNode();
  const list = document.getElementById("list");
  list.innerHTML = "";

  // folders first
  const folderNames = Object.keys(node.folders).sort((a,b)=>a.localeCompare(b,"ja"));
  for(const name of folderNames){
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="left">
        <div class="icon">ğŸ“</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(name)}</div>
          <div class="meta">ãƒ•ã‚©ãƒ«ãƒ€</div>
        </div>
      </div>
      <div class="small">é–‹ã</div>
    `;
    el.onclick = ()=>openFolder(name);
    el.oncontextmenu = (e)=>{ e.preventDefault(); select({type:"folder",name}); };
    el.ontouchstart = ()=>{ /* ç«¯æœ«ã«ã‚ˆã£ã¦é•·æŠ¼ã—åˆ¤å®šãŒé›£ã—ã„ã®ã§ã€ã‚¿ãƒƒãƒ—ã§é¸æŠã¯åˆ¥ã«ç”¨æ„ */ };
    el.addEventListener("click", (ev)=>{
      // æ™®é€šã‚¿ãƒƒãƒ—ï¼é–‹ãã€‚é¸æŠã—ãŸã„æ™‚ã¯å³ä¸Šã®ã€Œå‰Šé™¤ã€ç”¨ã«ã‚‚ã†ä¸€å›ã‚¿ãƒƒãƒ—ã§é¸æŠæ‰±ã„ã«ã—ã¦ã‚‚ã„ã„ãŒã€
      // ã“ã“ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œå…¥åŠ›æ¬„ã«åå‰å…¥ã‚Œã¦å‰Šé™¤ã€ã§ã‚‚é‹ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã‚‹ã€‚
    });
    list.appendChild(el);
  }

  // memos
  const memos = Object.entries(node.memos)
    .sort((a,b)=> (b[1].updatedAt||0) - (a[1].updatedAt||0));

  for(const [id, m] of memos){
    const title = (m.title && m.title.trim()) ? m.title.trim() : (m.text||"").split("\n")[0].slice(0,40) || "(ç„¡é¡Œ)";
    const len = (m.text||"").length;
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="left">
        <div class="icon">ğŸ“</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(title)}</div>
          <div class="meta">æ–‡å­—æ•°: ${len}</div>
        </div>
      </div>
      <div class="small">ç·¨é›†</div>
    `;
    el.onclick = ()=>openMemo(id);
    el.oncontextmenu = (e)=>{ e.preventDefault(); select({type:"memo",id}); };
    list.appendChild(el);
  }

  if(folderNames.length===0 && memos.length===0){
    const empty = document.createElement("div");
    empty.className = "small";
    empty.style.padding = "10px";
    empty.textContent = "ã“ã“ã¯ç©ºã€‚ï¼‹ãƒ•ã‚©ãƒ«ãƒ€ / ï¼‹ãƒ¡ãƒ¢ ã‹ã‚‰ä½œã‚Œã‚‹ã€‚";
    list.appendChild(empty);
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function openFolder(name){
  path.push(name);
  render();
}

function goUp(){
  if(path.length){ path.pop(); render(); }
}

function addFolder(){
  const name = document.getElementById("nameInput").value.trim();
  if(!name) return;
  const node = getNode();
  if(node.folders[name]) return;
  node.folders[name] = newNode();
  persist();
  document.getElementById("nameInput").value="";
  render();
}

function addMemo(){
  const title = document.getElementById("nameInput").value.trim();
  const node = getNode();
  const id = String(now()) + "_" + Math.random().toString(16).slice(2);
  node.memos[id] = { title: title||"", text:"", updatedAt: now() };
  persist();
  document.getElementById("nameInput").value="";
  render();
  openMemo(id);
}

function select(sel){
  selected = sel;
}

function deleteCurrent(){
  const node = getNode();

  // å‰Šé™¤å¯¾è±¡ã®æ±ºã‚æ–¹ï¼š1) é¸æŠãŒã‚ã‚Œã°ãã‚Œ 2) å…¥åŠ›æ¬„ã®åå‰ã§ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤ 3) ãã‚Œã§ã‚‚ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
  if(selected){
    if(selected.type==="folder"){
      delete node.folders[selected.name];
      selected=null;
      persist(); render(); return;
    }
    if(selected.type==="memo"){
      delete node.memos[selected.id];
      selected=null;
      persist(); render(); return;
    }
  }

  const name = document.getElementById("nameInput").value.trim();
  if(name && node.folders[name]){
    delete node.folders[name];
    persist();
    document.getElementById("nameInput").value="";
    render();
    return;
  }

  // ä½•ã‚‚æ±ºã¾ã£ã¦ãªã„ãªã‚‰ç„¡è¦–ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
}

function openMemo(id){
  const node = getNode();
  const m = node.memos[id];
  if(!m) return;

  editingMemoId = id;
  document.getElementById("editorView").style.display="flex";
  document.getElementById("editorTitle").textContent = m.title?.trim() ? m.title.trim() : "ğŸ“ ç„¡é¡Œ";
  document.getElementById("editor").value = m.text || "";
  updateCount();

  // è‡ªå‹•ä¿å­˜ï¼ˆå…¥åŠ›åœæ­¢ 600msï¼‰
  document.getElementById("editor").oninput = ()=>{
    updateCount();
    if(autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=>{ saveNow(true); }, 600);
  };
}

function updateCount(){
  const t = document.getElementById("editor").value || "";
  document.getElementById("editorCount").textContent = "æ–‡å­—æ•°: " + t.length;
}

function saveNow(silent=false){
  if(!editingMemoId) return;
  const node = getNode();
  const m = node.memos[editingMemoId];
  if(!m) return;

  m.text = document.getElementById("editor").value || "";
  m.updatedAt = now();
  persist();
  if(!silent) render(); // ä¸€è¦§ã®æ–‡å­—æ•°æ›´æ–°
}

function closeEditor(){
  saveNow(true);
  document.getElementById("editorView").style.display="none";
  editingMemoId = null;
  render();
}

render();
</script>
</body>
</html>
