<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ãƒ¡ãƒ¢å¸³ã‚¢ãƒ—ãƒª</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --ink:#1b1f2a;
      --muted:#6b7280;
      --line:#e6eaf2;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --danger:#ef4444;
      --ok:#10b981;
      --shadow:0 10px 25px rgba(16,24,40,.08);
      --r:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#eef4ff 0%, var(--bg) 35%);
      color:var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", sans-serif;
    }
    .app{
      max-width:980px;
      margin:0 auto;
      min-height:100%;
      padding:14px 14px 24px;
    }
    header{
      background:linear-gradient(135deg, #2563eb 0%, #3b82f6 55%, #60a5fa 100%);
      color:#fff;
      border-radius:18px;
      padding:16px 16px 14px;
      box-shadow:var(--shadow);
      position:sticky;
      top:10px;
      z-index:10;
    }
    .title{
      display:flex;align-items:center;gap:10px;
      font-weight:800;font-size:20px;
      letter-spacing:.5px;
    }
    .sub{
      margin-top:6px;
      font-size:12px;
      opacity:.9;
    }

    .screen{ display:none; margin-top:14px; }
    .screen.active{ display:block; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card-h h2{
      margin:0;
      font-size:16px;
      font-weight:800;
    }
    .card-b{
      padding:14px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex: 1 1 auto; }

    .btn{
      border:0;
      border-radius:12px;
      padding:11px 12px;
      font-weight:800;
      cursor:pointer;
      transition:.12s transform, .12s opacity, .12s background;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:44px;
    }
    .btn:active{ transform:scale(.98) }
    .btn.pri{ background:var(--pri); color:#fff; }
    .btn.pri:hover{ background:var(--pri2); }
    .btn.ghost{ background:#eef2ff; color:#1e3a8a; }
    .btn.danger{ background:#fee2e2; color:#991b1b; }
    .btn.gray{ background:#f1f5f9; color:#0f172a; }

    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:12px 12px;
      font-size:15px;
      outline:none;
    }
    textarea{
      resize:none;
      min-height:52vh;
      line-height:1.6;
      font-family: inherit;
      white-space: pre-wrap; /* å‹æ‰‹ã«æ•´å½¢ã—ãªã„ */
    }
    .muted{ color:var(--muted); font-size:12px; }
    .kpi{ font-weight:900; }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      background:#fff;
    }
    .item:hover{ outline:2px solid rgba(37,99,235,.08); }
    .item .meta{ flex:1; min-width:0; }
    .item .t{
      font-weight:900;
      font-size:15px;
      margin:0 0 6px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .item .p{
      margin:0;
      color:var(--muted);
      font-size:12px;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      word-break:break-word;
    }
    .item .right{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      min-width:110px;
    }
    .chip{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background:#eef2ff;
      color:#1e3a8a;
      white-space:nowrap;
    }
    .mini{
      padding:8px 10px;
     border-radius:10px;
     min-height:36px;
     font-weight:900;
     font-size:13px;
    }
    .mini.gray{ background:#f1f5f9; color:#0f172a; }
    .mini.danger{ background:#fee2e2; color:#991b1b; }

    .footerbar{
      position:sticky;
      bottom:10px;
      margin-top:12px;
      display:flex;
      gap:10px;
    }
    .footerbar .btn{ flex:1; }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .pill{
      background:#ffffffcc;
      border:1px solid rgba(255,255,255,.35);
      backdrop-filter: blur(8px);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .pill b{ font-size:13px; }

    /* Editor fullscreen feel */
    .editor-wrap{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .editor-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .editor-top .left{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .count{
      font-weight:900;
      color:#0f172a;
    }
    .dangerText{ color: #991b1b; font-weight:900; }

    @media (max-width:540px){
      .item{ flex-direction:column; }
      .item .right{ align-items:flex-start; min-width:0; width:100%; flex-direction:row; }
      textarea{ min-height:56vh; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="topbar">
        <div class="title">ğŸ“ ãƒ¡ãƒ¢å¸³ã‚¢ãƒ—ãƒª</div>
        <div class="pill">ğŸ“ <b id="pillFolder">ãƒ¡ãƒ¢</b>ã€€ï½œã€€æ–‡å­—æ•° <b id="pillCount">0</b></div>
      </div>
      <div class="sub">ãƒ•ã‚©ãƒ«ãƒ€ç„¡é™ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—æ•°ãƒ»å‹æ‰‹ã«æ•´å½¢ã—ãªã„ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ï¼æ”¹è¡Œãã®ã¾ã¾ï¼‰</div>
    </header>

    <!-- â‘  ä¸€è¦§ç”»é¢ -->
    <section id="screenList" class="screen active">
      <div class="card">
        <div class="card-h">
          <h2>ãƒ¡ãƒ¢ä¸€è¦§</h2>
          <button class="btn ghost mini" id="btnGoManage">ğŸ“ ç®¡ç†</button>
        </div>
        <div class="card-b">
          <div class="row" style="gap:10px; margin-bottom:10px;">
            <div style="flex: 1 1 220px;">
              <select id="folderSelect"></select>
            </div>
            <div style="flex: 2 1 320px;">
              <input id="searchInput" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼æœ¬æ–‡ï¼‰" />
            </div>
            <button class="btn pri" id="btnNewMemo" style="flex: 0 0 auto;">ï¼‹ æ–°è¦</button>
          </div>

          <div class="muted" id="listInfo">0ä»¶</div>
          <div class="list" id="memoList"></div>

          <div class="footerbar">
            <button class="btn gray" id="btnExport">â¬‡ é€€é¿ï¼ˆJSONï¼‰</button>
            <label class="btn gray" style="cursor:pointer;">
              â¬† å–è¾¼ï¼ˆJSONï¼‰
              <input id="importFile" type="file" accept="application/json" style="display:none;">
            </label>
          </div>

          <div class="muted" style="margin-top:10px;">
            â€»ä¿å­˜å…ˆï¼šlocalStorageï¼ˆã“ã®ç«¯æœ«ãƒ»ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰ã€‚<br>
            â€»ä¸‡ä¸€ã«å‚™ãˆã¦ãŸã¾ã«ã€Œé€€é¿ï¼ˆJSONï¼‰ã€ã—ã¦ãŠãã¨å®‰å…¨ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- â‘¡ ç®¡ç†ç”»é¢ -->
    <section id="screenManage" class="screen">
      <div class="card">
        <div class="card-h">
          <h2>ãƒ•ã‚©ãƒ«ãƒ€ç®¡ç†</h2>
          <button class="btn gray mini" id="btnBackFromManage">â† ä¸€è¦§ã¸</button>
        </div>
        <div class="card-b">
          <div class="row" style="margin-bottom:10px;">
            <input id="newFolderName" placeholder="æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€å" />
            <button class="btn pri" id="btnAddFolder" style="flex:0 0 auto;">ï¼‹ è¿½åŠ </button>
          </div>

          <div class="row" style="margin-bottom:10px;">
            <select id="manageFolderSelect"></select>
            <input id="renameFolderInput" placeholder="é¸æŠä¸­ãƒ•ã‚©ãƒ«ãƒ€åã‚’å¤‰æ›´" />
          </div>

          <div class="row">
            <button class="btn ghost" id="btnRenameFolder">âœï¸ åå‰å¤‰æ›´</button>
            <button class="btn danger" id="btnDeleteFolder">ğŸ—‘ï¸ ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤</button>
          </div>

          <div class="muted" style="margin-top:10px;">
            â€»å‰Šé™¤ã¯ã€Œãã®ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ¡ãƒ¢ã‚‚å…¨éƒ¨ã€æ¶ˆãˆã‚‹ï¼ˆç¢ºèªã‚ã‚Šï¼‰ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- â‘¢ ç·¨é›†ç”»é¢ -->
    <section id="screenEdit" class="screen">
      <div class="card">
        <div class="card-h">
          <h2 id="editHeader">ç·¨é›†</h2>
          <button class="btn gray mini" id="btnBackFromEdit">â† ä¸€è¦§ã¸</button>
        </div>
        <div class="card-b editor-wrap">
          <div class="editor-top">
            <div class="left">
              <span class="chip" id="editFolderChip">ğŸ“ ãƒ¡ãƒ¢</span>
              <span class="count">æ–‡å­—æ•°ï¼š<span id="editCount">0</span></span>
              <span class="muted" id="autosaveHint">è‡ªå‹•ä¿å­˜ï¼šON</span>
            </div>
            <div class="row" style="flex:1 1 auto; justify-content:flex-end;">
              <button class="btn pri" id="btnSave">ğŸ’¾ ä¿å­˜</button>
              <button class="btn danger" id="btnDeleteMemo">ğŸ—‘ å‰Šé™¤</button>
            </div>
          </div>

          <input id="memoTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç©ºãªã‚‰æœ¬æ–‡å†’é ­ãŒã‚¿ã‚¤ãƒˆãƒ«æ‰±ã„ï¼‰" />
          <textarea id="memoBody" placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã‚’æ›¸ã„ã¦ãã ã•ã„â€¦"></textarea>

          <div class="muted">
            â€»æ”¹è¡Œãƒ»å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹å«ã‚ã¦ãã®ã¾ã¾ä¿æŒï¼ˆå‹æ‰‹ã«æ•´å½¢ã—ãªã„ï¼‰<br>
            â€»å…¥åŠ›åœæ­¢ã‹ã‚‰600msã§è‡ªå‹•ä¿å­˜ï¼ˆä¿å­˜ãƒœã‚¿ãƒ³ã§ã‚‚ä¿å­˜å¯èƒ½ï¼‰
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
(() => {
  const LS_KEY = "kojimemo_v3_data";

  /** data schema:
   * { folders: [{id,name}], memos: [{id, folderId, title, body, updatedAt}] , selectedFolderId }
   */
  const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

  const nowISO = () => new Date().toISOString();

  const $ = (id) => document.getElementById(id);

  const screens = {
    list: $("screenList"),
    manage: $("screenManage"),
    edit: $("screenEdit")
  };

  const pillFolder = $("pillFolder");
  const pillCount = $("pillCount");

  const folderSelect = $("folderSelect");
  const manageFolderSelect = $("manageFolderSelect");
  const searchInput = $("searchInput");
  const memoList = $("memoList");
  const listInfo = $("listInfo");

  const newFolderName = $("newFolderName");
  const btnAddFolder = $("btnAddFolder");
  const renameFolderInput = $("renameFolderInput");
  const btnRenameFolder = $("btnRenameFolder");
  const btnDeleteFolder = $("btnDeleteFolder");

  const btnGoManage = $("btnGoManage");
  const btnBackFromManage = $("btnBackFromManage");

  const btnNewMemo = $("btnNewMemo");
  const btnBackFromEdit = $("btnBackFromEdit");
  const btnSave = $("btnSave");
  const btnDeleteMemo = $("btnDeleteMemo");

  const editHeader = $("editHeader");
  const editFolderChip = $("editFolderChip");
  const memoTitle = $("memoTitle");
  const memoBody = $("memoBody");
  const editCount = $("editCount");

  const btnExport = $("btnExport");
  const importFile = $("importFile");

  let state = load();
  let currentMemoId = null;
  let autosaveTimer = null;

  function defaultState(){
    const baseFolderId = uid();
    return {
      folders: [{ id: baseFolderId, name: "ãƒ¡ãƒ¢" }],
      memos: [],
      selectedFolderId: baseFolderId
    };
  }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      // ç°¡å˜ãªè£œæ­£
      if(!parsed.folders || !parsed.memos) return defaultState();
      if(!parsed.selectedFolderId) parsed.selectedFolderId = parsed.folders[0]?.id;
      return parsed;
    }catch(e){
      console.warn(e);
      return defaultState();
    }
  }

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function showScreen(which){
    Object.values(screens).forEach(s => s.classList.remove("active"));
    screens[which].classList.add("active");
  }

  function getFolderName(folderId){
    return state.folders.find(f => f.id === folderId)?.name || "ï¼ˆä¸æ˜ï¼‰";
  }

  function setSelectedFolder(folderId){
    state.selectedFolderId = folderId;
    save();
    syncFolderUI();
    renderList();
  }

  function syncFolderUI(){
    // selects
    folderSelect.innerHTML = "";
    manageFolderSelect.innerHTML = "";

    state.folders.forEach(f => {
      const opt1 = document.createElement("option");
      opt1.value = f.id;
      opt1.textContent = f.name;
      folderSelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = f.id;
      opt2.textContent = f.name;
      manageFolderSelect.appendChild(opt2);
    });

    folderSelect.value = state.selectedFolderId;
    manageFolderSelect.value = state.selectedFolderId;

    pillFolder.textContent = getFolderName(state.selectedFolderId);
  }

  function countChars(str){
    // ã“ã“ã¯ã€Œè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ–‡å­—æ•°ã€å„ªå…ˆï¼šæ”¹è¡Œã‚‚æ•°ãˆã‚‹ï¼ˆ\n ã‚‚1æ–‡å­—æ‰±ã„ï¼‰
    // JSã®lengthã§OK
    return (str ?? "").length;
  }

  function memoPreview(m){
    const title = (m.title && m.title.trim()) ? m.title.trim() : (m.body || "").trim().split("\n")[0].slice(0, 40);
    const body = (m.body || "").trim();
    const prev = body.length ? body.slice(0, 200) : "ï¼ˆæœ¬æ–‡ãªã—ï¼‰";
    return { title: title || "ï¼ˆç„¡é¡Œï¼‰", preview: prev };
  }

  function renderList(){
    const folderId = state.selectedFolderId;
    const q = (searchInput.value || "").trim().toLowerCase();

    const filtered = state.memos
      .filter(m => m.folderId === folderId)
      .filter(m => {
        if(!q) return true;
        return (m.title || "").toLowerCase().includes(q) || (m.body || "").toLowerCase().includes(q);
      })
      .sort((a,b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));

    memoList.innerHTML = "";

    listInfo.textContent = `${filtered.length}ä»¶`;

    filtered.forEach(m => {
      const { title, preview } = memoPreview(m);

      const wrap = document.createElement("div");
      wrap.className = "item";

      const meta = document.createElement("div");
      meta.className = "meta";

      const t = document.createElement("p");
      t.className = "t";
      t.textContent = title;

      const p = document.createElement("p");
      p.className = "p";
      p.textContent = preview;

      meta.appendChild(t);
      meta.appendChild(p);

      const right = document.createElement("div");
      right.className = "right";

      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = `å­—æ•° ${countChars(m.body)}`;

      const btnOpen = document.createElement("button");
      btnOpen.className = "btn pri mini";
      btnOpen.textContent = "é–‹ã";
      btnOpen.addEventListener("click", () => openMemo(m.id));

      right.appendChild(chip);
      right.appendChild(btnOpen);

      wrap.appendChild(meta);
      wrap.appendChild(right);

      memoList.appendChild(wrap);
    });

    // pill count = ãƒ•ã‚©ãƒ«ãƒ€å†…åˆè¨ˆã˜ã‚ƒãªãã€Œä»Šè¦‹ãˆã¦ã‚‹ä»¶æ•°ã€ã§ã¯ãªãã€
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›çš„ã«ã€Œé¸æŠä¸­ãƒ¡ãƒ¢ã®æ–‡å­—æ•°ã€ã‚’å‡ºã™ã€‚
    // é¸æŠä¸­ãŒãªã„ã¨ãã¯0
    pillCount.textContent = (currentMemoId ? (countChars(getMemo(currentMemoId)?.body) || 0) : 0);
  }

  function getMemo(id){
    return state.memos.find(m => m.id === id);
  }

  function openMemo(id){
    const m = getMemo(id);
    if(!m) return;

    currentMemoId = id;

    editHeader.textContent = "ç·¨é›†";
    editFolderChip.textContent = `ğŸ“ ${getFolderName(m.folderId)}`;

    memoTitle.value = m.title || "";
    memoBody.value = m.body || "";

    updateCounts();

    showScreen("edit");
    // ã‚«ãƒ¼ã‚½ãƒ«ã™ãæ‰“ã¦ã‚‹ã‚ˆã†ã«
    setTimeout(() => memoBody.focus(), 50);
  }

  function newMemo(){
    const folderId = state.selectedFolderId;
    const m = {
      id: uid(),
      folderId,
      title: "",
      body: "",
      updatedAt: nowISO()
    };
    state.memos.push(m);
    save();
    renderList();
    openMemo(m.id);
  }

  function updateCounts(){
    const c = countChars(memoBody.value);
    editCount.textContent = c;
    pillCount.textContent = c;
    pillFolder.textContent = getFolderName(state.selectedFolderId);
  }

  function commitMemo(){
    if(!currentMemoId) return;
    const m = getMemo(currentMemoId);
    if(!m) return;

    m.title = memoTitle.value ?? "";
    m.body = memoBody.value ?? "";
    m.updatedAt = nowISO();

    save();
    updateCounts();
  }

  function scheduleAutosave(){
    if(autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => {
      commitMemo();
      renderList(); // åæ˜ ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚„æ›´æ–°é †ï¼‰
    }, 600);
  }

  function backToList(){
    // ç·¨é›†ä¸­ã®å†…å®¹ã¯ä¿å­˜ã—ã¦ã‹ã‚‰æˆ»ã‚‹
    commitMemo();
    save();
    showScreen("list");
    renderList();
  }

  function addFolder(){
    const name = (newFolderName.value || "").trim();
    if(!name) return alert("ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥ã‚Œã¦ã€‚");
    // åŒåã§ã‚‚OKï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç”±ï¼‰
    const f = { id: uid(), name };
    state.folders.push(f);
    newFolderName.value = "";
    state.selectedFolderId = f.id;
    save();
    syncFolderUI();
    renderList();
    alert(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${name}ã€ã‚’è¿½åŠ ã—ãŸã€‚`);
  }

  function renameFolder(){
    const folderId = manageFolderSelect.value;
    const name = (renameFolderInput.value || "").trim();
    if(!name) return alert("æ–°ã—ã„åå‰ã‚’å…¥ã‚Œã¦ã€‚");
    const f = state.folders.find(x => x.id === folderId);
    if(!f) return;
    f.name = name;
    renameFolderInput.value = "";
    save();
    syncFolderUI();
    renderList();
    alert("åå‰ã‚’å¤‰æ›´ã—ãŸã€‚");
  }

  function deleteFolder(){
    const folderId = manageFolderSelect.value;
    const f = state.folders.find(x => x.id === folderId);
    if(!f) return;

    if(state.folders.length <= 1){
      return alert("æœ€å¾Œã®ãƒ•ã‚©ãƒ«ãƒ€ã¯å‰Šé™¤ã§ããªã„ã€‚");
    }

    const count = state.memos.filter(m => m.folderId === folderId).length;
    const ok = confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${f.name}ã€ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ\nä¸­ã®ãƒ¡ãƒ¢ ${count} ä»¶ã‚‚å…¨éƒ¨æ¶ˆãˆã‚‹ã€‚`);
    if(!ok) return;

    // remove memos
    state.memos = state.memos.filter(m => m.folderId !== folderId);
    // remove folder
    state.folders = state.folders.filter(x => x.id !== folderId);

    // fix selection
    if(state.selectedFolderId === folderId){
      state.selectedFolderId = state.folders[0].id;
    }
    if(currentMemoId && getMemo(currentMemoId)?.folderId === folderId){
      currentMemoId = null;
    }

    save();
    syncFolderUI();
    renderList();
    alert("å‰Šé™¤ã—ãŸã€‚");
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "kojimemo_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }

  function importJSONFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        if(!parsed || !parsed.folders || !parsed.memos){
          return alert("å½¢å¼ãŒé•ã†ã£ã½ã„ã€‚");
        }
        state = parsed;
        if(!state.selectedFolderId && state.folders[0]) state.selectedFolderId = state.folders[0].id;
        currentMemoId = null;
        save();
        syncFolderUI();
        renderList();
        alert("å–è¾¼å®Œäº†ã€‚");
      }catch(e){
        console.error(e);
        alert("JSONã®èª­ã¿è¾¼ã¿ã§å¤±æ•—ã—ãŸã€‚");
      }
    };
    reader.readAsText(file);
  }

  function deleteCurrentMemo(){
    if(!currentMemoId) return;
    const m = getMemo(currentMemoId);
    if(!m) return;
    const { title } = memoPreview(m);
    if(!confirm(`ãƒ¡ãƒ¢ã€Œ${title}ã€ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ`)) return;

    state.memos = state.memos.filter(x => x.id !== currentMemoId);
    currentMemoId = null;
    save();
    showScreen("list");
    renderList();
  }

  // events
  folderSelect.addEventListener("change", () => setSelectedFolder(folderSelect.value));
  manageFolderSelect.addEventListener("change", () => {
    // ç®¡ç†ç”»é¢å´ã®é¸æŠå¤‰æ›´ã§ç¾åœ¨é¸æŠãƒ•ã‚©ãƒ«ãƒ€ã‚‚åŒæœŸ
    setSelectedFolder(manageFolderSelect.value);
  });

  searchInput.addEventListener("input", renderList);

  btnNewMemo.addEventListener("click", newMemo);

  btnGoManage.addEventListener("click", () => {
    showScreen("manage");
    syncFolderUI();
  });

  btnBackFromManage.addEventListener("click", () => {
    showScreen("list");
    renderList();
  });

  btnAddFolder.addEventListener("click", addFolder);
  btnRenameFolder.addEventListener("click", renameFolder);
  btnDeleteFolder.addEventListener("click", deleteFolder);

  btnBackFromEdit.addEventListener("click", backToList);
  btnSave.addEventListener("click", () => { commitMemo(); save(); renderList(); alert("ä¿å­˜ã—ãŸã€‚"); });
  btnDeleteMemo.addEventListener("click", deleteCurrentMemo);

  memoTitle.addEventListener("input", () => { updateCounts(); scheduleAutosave(); });
  memoBody.addEventListener("input", () => { updateCounts(); scheduleAutosave(); });

  btnExport.addEventListener("click", exportJSON);
  importFile.addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if(f) importJSONFile(f);
    importFile.value = "";
  });

  // init
  syncFolderUI();
  renderList();
})();
</script>
</body>
</html>
