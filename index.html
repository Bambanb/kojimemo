<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãƒ¡ãƒ¢å¸³ã‚¢ãƒ—ãƒª</title>
  <style>
    :root{
      --bg:#f3f6fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --brand:#3b82f6; --brand2:#2563eb; --border:#e5e7eb;
      --danger:#ef4444; --ok:#10b981;
      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --r:16px;
      --pad:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#eef5ff, var(--bg));
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--ink);
    }
    header{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff; padding:18px 14px;
      box-shadow: 0 8px 20px rgba(37,99,235,.25);
    }
    header .title{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.02em; font-size:20px;
      justify-content:center;
    }
    header .sub{
      display:flex; justify-content:center; gap:10px;
      margin-top:8px; font-size:12px; opacity:.92;
    }
    .wrap{
      max-width:1100px; margin:14px auto; padding:0 12px 18px;
    }
    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1fr;
    }
    @media(min-width:860px){
      .grid{ grid-template-columns: 360px 1fr; }
    }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius: var(--r); box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px; font-size:16px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .card h2 .small{font-size:12px; color:var(--muted); font-weight:600}
    .card .body{ padding:14px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row + .row{ margin-top:10px; }

    input[type="text"], textarea, select{
      width:100%;
      font:inherit;
      padding:12px;
      border:1px solid var(--border);
      border-radius: 12px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height: 160px; resize: vertical; }

    .btn{
      border:0; border-radius: 14px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      background: #e2e8f0;
      color: var(--ink);
      box-shadow: 0 6px 14px rgba(2,6,23,.06);
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff; }
    .btn.ghost{ background:#fff; border:1px solid var(--border); box-shadow:none; }
    .btn.danger{ background: #fee2e2; color:#991b1b; }
    .btn.ok{ background: #dcfce7; color:#065f46; }

    .list{
      margin-top:10px;
      border-top:1px solid var(--border);
    }
    .item{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
    }
    .item:hover{ background:#f8fafc; }
    .item.active{ background:#eff6ff; }
    .meta{ color:var(--muted); font-size:12px; }
    .titleline{ font-weight:800; }
    .badge{
      font-size:12px; font-weight:800; color:#fff;
      background: #0f172a;
      padding:6px 10px; border-radius: 999px;
      opacity:.85;
      white-space:nowrap;
    }
    .badge.muted{ background:#334155; }
    .hint{
      color:var(--muted); font-size:12px; line-height:1.6;
    }
    .split{
      display:grid; gap:10px; grid-template-columns: 1fr;
    }
    @media(min-width:520px){
      .split{ grid-template-columns: 1fr auto; align-items:center; }
    }

    /* Fullscreen editor */
    .overlay{
      position:fixed; inset:0; z-index:50;
      background: rgba(2,6,23,.55);
      display:none;
      padding: 10px;
    }
    .overlay.show{ display:block; }
    .sheet{
      height:100%;
      background: var(--card);
      border-radius: 18px;
      border:1px solid var(--border);
      box-shadow: 0 25px 60px rgba(2,6,23,.25);
      display:flex; flex-direction:column;
      overflow:hidden;
    }
    .sheetbar{
      padding:12px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--border);
      background: #f8fafc;
    }
    .sheetbar .left, .sheetbar .right{ display:flex; align-items:center; gap:8px; }
    .sheetbar .name{
      font-weight:900;
      max-width: 52vw;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .sheetbar .count{ color:var(--muted); font-size:12px; font-weight:800; }
    .sheetcontent{ padding:12px; display:flex; flex-direction:column; gap:10px; flex:1; }
    .sheetcontent textarea{
      flex:1;
      min-height: 55vh;
      resize:none;
      border-radius: 14px;
      line-height: 1.75;
      padding:14px;
    }
    .sheetcontent input[type="text"]{
      font-weight:800;
    }
    .toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:#0f172a; color:#fff; padding:10px 14px;
      border-radius: 999px; font-weight:800; font-size:12px;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:60;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }
    .smalllink{ font-size:12px; color:#2563eb; font-weight:800; cursor:pointer; user-select:none; }
    .hr{ height:1px; background:var(--border); margin:10px 0; }
  </style>
</head>
<body>
  <header>
    <div class="title">ğŸ“ ãƒ¡ãƒ¢å¸³ã‚¢ãƒ—ãƒª</div>
    <div class="sub">
      <span>ãƒ•ã‚©ãƒ«ãƒ€ç„¡é™</span>
      <span>ãƒ»</span>
      <span>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—æ•°</span>
      <span>ãƒ»</span>
      <span>å‹æ‰‹ã«æ•´å½¢ã—ãªã„</span>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Left: folders -->
      <section class="card">
        <h2>
          <span>ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€</span>
          <span class="small" id="folderCount"></span>
        </h2>
        <div class="body">
          <div class="row">
            <input id="newFolderName" type="text" placeholder="æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€å" />
            <button class="btn primary" id="addFolderBtn">ï¼‹ ãƒ•ã‚©ãƒ«ãƒ€è¿½åŠ </button>
          </div>

          <div class="row" style="margin-top:10px">
            <select id="folderSelect"></select>
          </div>

          <div class="row">
            <input id="renameFolderInput" type="text" placeholder="é¸æŠä¸­ãƒ•ã‚©ãƒ«ãƒ€åã‚’å¤‰æ›´" />
            <button class="btn ghost" id="renameFolderBtn">âœï¸ åå‰å¤‰æ›´</button>
            <button class="btn danger" id="deleteFolderBtn">ğŸ—‘ï¸ ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤</button>
          </div>

          <div class="hr"></div>
          <div class="hint">
            ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ã‚‚ãƒ¡ãƒ¢ã‚‚ <b>localStorage</b> ã«ä¿å­˜ï¼ˆç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶å˜ä½ï¼‰ã€‚<br/>
            ãƒ»å¼·åˆ¶æ•´å½¢ãªã—ã€‚å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚‚æ”¹è¡Œã‚‚ãã®ã¾ã¾ã€‚<br/>
            ãƒ»å¿µã®ãŸã‚è‡ªå‹•ä¿å­˜ã‚ã‚Šï¼ˆå…¥åŠ›åœæ­¢600msï¼‰ã€‚
          </div>
        </div>
      </section>

      <!-- Right: notes list + quick editor launch -->
      <section class="card">
        <h2>
          <span id="rightTitle">ãƒ¡ãƒ¢</span>
          <span class="small" id="noteCount"></span>
        </h2>
        <div class="body">
          <div class="split">
            <div class="row" style="flex:1">
              <button class="btn primary" id="newNoteBtn">ğŸ—’ï¸ æ–°è¦ãƒ¡ãƒ¢</button>
              <button class="btn ghost" id="openEditorBtn" disabled>ğŸ–Šï¸ ç·¨é›†ï¼ˆå…¨ç”»é¢ï¼‰</button>
              <button class="btn ghost" id="exportBtn">â¬‡ï¸ é€€é¿</button>
              <label class="btn ghost" style="gap:8px">
                â¬†ï¸ å–è¾¼
                <input id="importFile" type="file" accept="application/json" hidden />
              </label>
            </div>
            <div class="row" style="justify-content:flex-end">
              <span class="hint">é¸æŠä¸­: <b id="currentNoteName">ãªã—</b></span>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <input id="searchInput" type="text" placeholder="ãƒ¡ãƒ¢æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/æœ¬æ–‡ï¼‰" />
            <button class="btn ghost" id="clearSearchBtn">ã‚¯ãƒªã‚¢</button>
          </div>

          <div class="list" id="noteList"></div>

          <div class="hint" style="margin-top:10px">
            ãƒ»ãƒ¡ãƒ¢åã¯ã€Œã‚¿ã‚¤ãƒˆãƒ«ã€å„ªå…ˆã€‚ç©ºãªã‚‰ã€Œæœ¬æ–‡ã®1è¡Œç›®ã€ã‚’è¡¨ç¤ºã€‚<br/>
            ãƒ»ä¸¦ã³ã¯<b>æ›´æ–°æ—¥æ™‚ï¼ˆæ–°ã—ã„é †ï¼‰</b>ã€‚æ¢ã›ãªã„åœ°ç„ã‚’æ¸›ã‚‰ã™ã€‚<br/>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Fullscreen Editor Overlay -->
  <div class="overlay" id="overlay">
    <div class="sheet">
      <div class="sheetbar">
        <div class="left">
          <button class="btn ghost" id="backBtn">â† æˆ»ã‚‹</button>
          <div>
            <div class="name" id="editorFolderName"></div>
            <div class="count">æ–‡å­—æ•°: <span id="editorCharCount">0</span> / æ›´æ–°: <span id="editorUpdatedAt">-</span></div>
          </div>
        </div>
        <div class="right">
          <button class="btn ok" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
          <button class="btn danger" id="deleteNoteBtn">ğŸ—‘ï¸ å‰Šé™¤</button>
        </div>
      </div>
      <div class="sheetcontent">
        <input id="editorTitle" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰" />
        <textarea id="editorBody" placeholder="æœ¬æ–‡â€¦ï¼ˆæ•´å½¢ã—ãªã„ã€‚ç©ºç™½ã‚‚æ”¹è¡Œã‚‚ãã®ã¾ã¾ï¼‰"></textarea>
        <div class="row" style="justify-content:space-between">
          <span class="hint">â€» ä¿å­˜ãƒœã‚¿ãƒ³ï¼‹è‡ªå‹•ä¿å­˜ï¼ˆå…¥åŠ›åœæ­¢å¾Œï¼‰</span>
          <span class="smalllink" id="copyBtn">æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼</span>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const KEY = "kojimemo_v2_data";

  const el = (id) => document.getElementById(id);
  const folderSelect = el("folderSelect");
  const newFolderName = el("newFolderName");
  const addFolderBtn = el("addFolderBtn");
  const renameFolderInput = el("renameFolderInput");
  const renameFolderBtn = el("renameFolderBtn");
  const deleteFolderBtn = el("deleteFolderBtn");

  const rightTitle = el("rightTitle");
  const folderCount = el("folderCount");
  const noteCount = el("noteCount");
  const noteList = el("noteList");
  const newNoteBtn = el("newNoteBtn");
  const openEditorBtn = el("openEditorBtn");
  const currentNoteName = el("currentNoteName");

  const searchInput = el("searchInput");
  const clearSearchBtn = el("clearSearchBtn");

  const exportBtn = el("exportBtn");
  const importFile = el("importFile");

  const overlay = el("overlay");
  const backBtn = el("backBtn");
  const saveBtn = el("saveBtn");
  const deleteNoteBtn = el("deleteNoteBtn");
  const editorFolderName = el("editorFolderName");
  const editorTitle = el("editorTitle");
  const editorBody = el("editorBody");
  const editorCharCount = el("editorCharCount");
  const editorUpdatedAt = el("editorUpdatedAt");
  const copyBtn = el("copyBtn");

  const toast = el("toast");

  const nowISO = () => new Date().toISOString();
  const fmtTime = (iso) => {
    if (!iso) return "-";
    const d = new Date(iso);
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  };

  const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

  const defaultData = () => ({
    v: 2,
    folders: [
      { id: uid(), name: "ãƒ¡ãƒ¢", createdAt: nowISO() }
    ],
    notes: [
      // { id, folderId, title, body, createdAt, updatedAt }
    ],
    state: { folderId: null, noteId: null }
  });

  const load = () => {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return defaultData();
      const data = JSON.parse(raw);
      if (!data || !data.folders) return defaultData();
      if (!data.state) data.state = { folderId: null, noteId: null };
      if (!data.notes) data.notes = [];
      if (!data.v) data.v = 2;
      return data;
    } catch {
      return defaultData();
    }
  };

  const save = () => localStorage.setItem(KEY, JSON.stringify(db));

  const toastMsg = (msg) => {
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toast.classList.remove("show"), 900);
  };

  let db = load();

  const ensureState = () => {
    if (!db.folders.length) db.folders.push({ id: uid(), name: "ãƒ¡ãƒ¢", createdAt: nowISO() });
    if (!db.state.folderId || !db.folders.find(f=>f.id===db.state.folderId)) {
      db.state.folderId = db.folders[0].id;
    }
    if (db.state.noteId && !db.notes.find(n=>n.id===db.state.noteId)) db.state.noteId = null;
  };

  const getFolder = (id) => db.folders.find(f=>f.id===id);
  const getNote = (id) => db.notes.find(n=>n.id===id);

  const noteDisplayName = (n) => {
    const t = (n.title || "").trim();
    if (t) return t;
    const first = (n.body || "").split("\n")[0] || "";
    return first.trim() ? first.trim().slice(0, 60) : "ï¼ˆç„¡é¡Œï¼‰";
  };

  const countChars = (s) => {
    // JSã®lengthã€‚å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚‚æ”¹è¡Œã‚‚å«ã‚€ï¼ˆå‹æ‰‹ã«å‰Šã‚‰ãªã„ï¼‰
    return (s ?? "").length;
  };

  const filteredNotes = () => {
    const fid = db.state.folderId;
    const q = (searchInput.value || "").trim().toLowerCase();
    let list = db.notes.filter(n=>n.folderId===fid);
    if (q) {
      list = list.filter(n=>{
        const name = noteDisplayName(n).toLowerCase();
        const body = (n.body||"").toLowerCase();
        return name.includes(q) || body.includes(q);
      });
    }
    // æ›´æ–°ãŒæ–°ã—ã„é †
    list.sort((a,b)=>(b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt));
    return list;
  };

  const renderFolders = () => {
    folderSelect.innerHTML = "";
    db.folders.forEach(f=>{
      const opt = document.createElement("option");
      opt.value = f.id;
      opt.textContent = f.name;
      if (f.id === db.state.folderId) opt.selected = true;
      folderSelect.appendChild(opt);
    });
    folderCount.textContent = `${db.folders.length} å€‹`;
    const f = getFolder(db.state.folderId);
    rightTitle.textContent = f ? f.name : "ãƒ¡ãƒ¢";
    editorFolderName.textContent = f ? `ğŸ“ ${f.name}` : "ğŸ“ -";
  };

  const renderNotes = () => {
    const list = filteredNotes();
    noteCount.textContent = `${list.length} ä»¶`;
    noteList.innerHTML = "";
    if (!list.length) {
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div>
        <div class="titleline">ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“</div>
        <div class="meta">ã€Œæ–°è¦ãƒ¡ãƒ¢ã€ã‹ã‚‰ä½œæˆã§ãã¾ã™</div>
      </div>
      <span class="badge muted">0</span>`;
      empty.style.cursor = "default";
      noteList.appendChild(empty);
    } else {
      list.forEach(n=>{
        const div = document.createElement("div");
        div.className = "item" + (n.id === db.state.noteId ? " active" : "");
        const name = noteDisplayName(n);
        const chars = countChars(n.body||"");
        div.innerHTML = `
          <div style="min-width:0">
            <div class="titleline">${escapeHtml(name)}</div>
            <div class="meta">æ›´æ–°: ${fmtTime(n.updatedAt||n.createdAt)}</div>
          </div>
          <span class="badge">${chars}</span>
        `;
        div.onclick = () => {
          db.state.noteId = n.id;
          save();
          renderAll();
        };
        noteList.appendChild(div);
      });
    }

    const cur = db.state.noteId ? getNote(db.state.noteId) : null;
    currentNoteName.textContent = cur ? noteDisplayName(cur) : "ãªã—";
    openEditorBtn.disabled = !cur;
  };

  const renderAll = () => {
    ensureState();
    renderFolders();
    renderNotes();
  };

  const addFolder = () => {
    const name = (newFolderName.value || "").trim();
    if (!name) return toastMsg("ãƒ•ã‚©ãƒ«ãƒ€åãŒç©º");
    const f = { id: uid(), name, createdAt: nowISO() };
    db.folders.push(f);
    db.state.folderId = f.id;
    db.state.noteId = null;
    newFolderName.value = "";
    save();
    renderAll();
    toastMsg("ãƒ•ã‚©ãƒ«ãƒ€è¿½åŠ ");
  };

  const renameFolder = () => {
    const name = (renameFolderInput.value || "").trim();
    if (!name) return toastMsg("æ–°ã—ã„åå‰ãŒç©º");
    const f = getFolder(db.state.folderId);
    if (!f) return;
    f.name = name;
    renameFolderInput.value = "";
    save();
    renderAll();
    toastMsg("åå‰å¤‰æ›´");
  };

  const deleteFolder = () => {
    const f = getFolder(db.state.folderId);
    if (!f) return;
    if (db.folders.length === 1) return toastMsg("æœ€å¾Œã®ãƒ•ã‚©ãƒ«ãƒ€ã¯å‰Šé™¤ã§ããªã„");
    if (!confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${f.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nä¸­ã®ãƒ¡ãƒ¢ã‚‚å…¨å‰Šé™¤ã§ã™ã€‚OKï¼Ÿ`)) return;

    const fid = f.id;
    db.folders = db.folders.filter(x=>x.id!==fid);
    db.notes = db.notes.filter(n=>n.folderId!==fid);
    db.state.folderId = db.folders[0].id;
    db.state.noteId = null;
    save();
    renderAll();
    toastMsg("ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤");
  };

  const newNote = () => {
    const n = {
      id: uid(),
      folderId: db.state.folderId,
      title: "",
      body: "",
      createdAt: nowISO(),
      updatedAt: nowISO()
    };
    db.notes.push(n);
    db.state.noteId = n.id;
    save();
    renderAll();
    openEditor();
    toastMsg("æ–°è¦ãƒ¡ãƒ¢");
  };

  let autosaveTimer = null;
  const scheduleAutoSave = () => {
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=> {
      if (!overlay.classList.contains("show")) return;
      doSave(false);
    }, 600);
  };

  const openEditor = () => {
    const n = getNote(db.state.noteId);
    if (!n) return;
    overlay.classList.add("show");
    editorTitle.value = n.title || "";
    editorBody.value = n.body || "";
    editorCharCount.textContent = countChars(editorBody.value);
    editorUpdatedAt.textContent = fmtTime(n.updatedAt || n.createdAt);
    editorFolderName.textContent = `ğŸ“ ${getFolder(n.folderId)?.name ?? "-"}`;
    // focus body for â€œã‚¢ãƒ—ãƒªã£ã½ã„â€
    setTimeout(()=>editorBody.focus(), 50);
  };

  const closeEditor = () => {
    overlay.classList.remove("show");
  };

  const doSave = (showToast=true) => {
    const n = getNote(db.state.noteId);
    if (!n) return;
    n.title = editorTitle.value ?? "";
    n.body = editorBody.value ?? "";
    n.updatedAt = nowISO();
    save();
    editorUpdatedAt.textContent = fmtTime(n.updatedAt);
    renderNotes();
    if (showToast) toastMsg("ä¿å­˜");
  };

  const deleteNote = () => {
    const n = getNote(db.state.noteId);
    if (!n) return;
    if (!confirm(`ãƒ¡ãƒ¢ã€Œ${noteDisplayName(n)}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ`)) return;
    db.notes = db.notes.filter(x=>x.id!==n.id);
    db.state.noteId = null;
    save();
    closeEditor();
    renderAll();
    toastMsg("å‰Šé™¤");
  };

  const escapeHtml = (s) => (s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));

  const exportData = () => {
    const blob = new Blob([JSON.stringify(db, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `kojimemo_backup_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toastMsg("é€€é¿ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ");
  };

  const importData = async (file) => {
    try{
      const text = await file.text();
      const incoming = JSON.parse(text);
      if (!incoming || !incoming.folders || !incoming.notes) throw new Error("invalid");
      // ã–ã£ãã‚Šä¸Šæ›¸ãï¼ˆã“ã®ç«¯æœ«ã®å€‰åº«ã¨ã—ã¦ä½¿ã†æƒ³å®šï¼‰
      db = incoming;
      if (!db.state) db.state = { folderId:null, noteId:null };
      save();
      renderAll();
      toastMsg("å–è¾¼OK");
    }catch{
      toastMsg("å–è¾¼å¤±æ•—");
    }
  };

  const copyBody = async () => {
    try{
      await navigator.clipboard.writeText(editorBody.value || "");
      toastMsg("ã‚³ãƒ”ãƒ¼ã—ãŸ");
    }catch{
      toastMsg("ã‚³ãƒ”ãƒ¼å¤±æ•—");
    }
  };

  // Events
  addFolderBtn.onclick = addFolder;
  folderSelect.onchange = () => {
    db.state.folderId = folderSelect.value;
    db.state.noteId = null;
    save();
    renderAll();
  };
  renameFolderBtn.onclick = renameFolder;
  deleteFolderBtn.onclick = deleteFolder;

  newNoteBtn.onclick = newNote;
  openEditorBtn.onclick = openEditor;

  backBtn.onclick = () => {
    // æˆ»ã‚‹å‰ã«é™ã‹ã«ä¿å­˜
    if (overlay.classList.contains("show")) doSave(false);
    closeEditor();
  };
  saveBtn.onclick = () => doSave(true);
  deleteNoteBtn.onclick = deleteNote;

  editorTitle.addEventListener("input", () => scheduleAutoSave());
  editorBody.addEventListener("input", () => {
    editorCharCount.textContent = countChars(editorBody.value);
    scheduleAutoSave();
  });

  overlay.addEventListener("click", (e)=>{
    // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ãªã„ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
    // ä½•ã‚‚ã—ãªã„
  });

  searchInput.addEventListener("input", renderNotes);
  clearSearchBtn.onclick = () => { searchInput.value=""; renderNotes(); };

  exportBtn.onclick = exportData;
  importFile.onchange = (e) => {
    const f = e.target.files?.[0];
    if (f) importData(f);
    importFile.value = "";
  };

  copyBtn.onclick = copyBody;

  // åˆæœŸåŒ–
  ensureState();
  save();
  renderAll();
})();
</script>
</body>
</html>
